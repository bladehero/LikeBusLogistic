@model RepairSpecialistsForLocationVM

@{
    RoleName roleName = (RoleName)ViewBag.RoleName;
}

<div uk-grid>
    <div class="uk-width-1-1 uk-margin-small-bottom uk-margin-remove-top">
        <p class="uk-text-bold">@Model.Location.Name</p>
    </div>
    <div class="uk-width-1-1 uk-margin-remove-bottom uk-margin-remove-top">
        @if (Model.Location.CityId.HasValue || Model.Location.CountryId.HasValue || Model.Location.DistrictId.HasValue)
        {
            <p class="uk-text-muted location-info">
                @if (!string.IsNullOrWhiteSpace(Model.Location.CountryName))
                {
                    <span>@Model.Location.CountryName</span>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Location.DistrictName))
                {
                    <span>@Model.Location.DistrictName</span>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Location.CityName))
                {
                    <span>@Model.Location.CityName</span>
                }
            </p>
        }
    </div>
</div>
<div class="uk-float-right">
    @if (roleName == RoleName.Administrator || roleName == RoleName.Moderator)
    {
        <button class="uk-button uk-button-small uk-button-primary" 
                id="add-specialist-button"
                data-location-id="@Model.Location.Id">
            Добавить
        </button>
    }
</div>
<table class="uk-table uk-table-small uk-table-hover" id="specialists-table">
    <thead>
        <tr>
            <th>ФИО</th>
            <th>Контактные данные</th>
            <th></th>
        </tr>
    </thead>
    <tbody data-location-id="@Model.Location.Id">
        @foreach (var specialist in Model.RepairSpecialists)
        {
            <tr data-specialist-id="@specialist.Id">
                <td>@specialist.Name</td>
                <td>@specialist.Contact</td>
                <td class="uk-float-right tool-cell-2">
                    @if (roleName == RoleName.Administrator || roleName == RoleName.Moderator)
                    {
                        @CustomExtensions.HtmlEditIcon("uk-margin-small-right edit-specialist-icon")
                    }
                    @if (roleName == RoleName.Administrator)
                    {
                        @CustomExtensions.HtmlDeleteOrRestoreIcon(specialist.IsDeleted, "delete-specialist-icon")
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    $('#specialists-table').dataTable();
    $('#add-specialist-button').click(function () {
        let locationId = $(this).data('location-id');
        Swal.mixin({
            input: 'textarea',
            confirmButtonText: 'Далее',
            showCancelButton: true,
            progressSteps: ['1', '2']
        }).queue([
            {
                title: 'ФИО',
                text: 'Введите имя специалиста по ремонту...'
            },
            {
                title: 'Контактные данные',
                text: 'Введите контактные данные...'
            }
        ]).then((result) => {
            if (result.value) {
                let name = result.value[0];
                let contact = result.value[1];
                App.postDataOnServer(
                    '@Url.Action("MergeRepairSpecialist", "Geolocation")',
                    { locationId: locationId, name: name, contact: contact }
                );
            }
        });
    });
    $('.edit-specialist-icon').click(function () {
        let id = $(this).parents('tr').first().data('specialist-id');
        let locationId = $(this).parents('tbody').first().data('location-id');
        Swal.mixin({
            input: 'text',
            confirmButtonText: 'Далее',
            showCancelButton: true,
            progressSteps: ['1', '2']
        }).queue([
            {
                title: 'ФИО'
            },
            {
                title: 'Контактные данные',
                text: 'Введите новые контактные данные...'
            }
        ]).then((result) => {
            if (result.value) {
                let name = result.value[0];
                let contact = result.value[1];
                App.postDataOnServer(
                    '@Url.Action("MergeRepairSpecialist", "Geolocation")',
                    { id: id, locationId: locationId, name: name, contact: contact }
                );
            }
        });
    });
    $('.delete-specialist-icon').click(function () {
        var id = $(this).parents('tr').data('specialist-id');
        App.postDataOnServer(
            '@Url.Action("DeleteOrRestoreSpecialist", "Geolocation")',
            { id: id },
            function (result) {
                App.message.showSuccessWithOk('Успешно', result.message || 'Специалист успешно удален!');
                App.loadContent(
                    '#specialists-modal>div.uk-modal-body',
                    '@Url.Action("_RepairSpecialistsForLocation", "Geolocation")',
                    { locationId: id }
                );
            }
        );
    });
</script>